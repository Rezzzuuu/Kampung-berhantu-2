<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üëª Sejarah - Kampung Berhantu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="h-[100dvh] bg-main text-gray-200 font-sans flex flex-col overflow-hidden">
    
  <div id="navbar-placeholder" class="shrink-0 z-50"></div>
  <script src="header.js"></script>

  <div class="flex-1 flex flex-col w-full max-w-4xl mx-auto overflow-hidden relative">
      
      <div class="absolute inset-0 z-0 flex pointer-events-none">
        <div class="w-1/2 h-full bg-gradient-to-r from-red-950/10 to-transparent"></div>
        <div class="w-1/2 h-full bg-gradient-to-l from-emerald-950/10 to-transparent"></div>
      </div>

      <div class="shrink-0 p-4 md:p-6 border-b border-emerald-800/30 bg-black/20 backdrop-blur-sm z-10">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="font-title text-2xl md:text-3xl text-emerald-400 uppercase tracking-widest flex items-center gap-2">
                    <span>üìú</span> Arkib Kampung
                </h1>
                <p class="text-gray-400 text-xs md:text-sm italic">Rekod sejarah permainan.</p>
            </div>

            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="downloadHistoryTxt()" class="flex-1 md:flex-none px-4 py-2 bg-blue-900/50 border border-blue-600 hover:bg-blue-800 text-blue-100 text-xs font-bold rounded flex items-center justify-center gap-2 transition">
                    <span>üì•</span> <span class="hidden md:inline">Muat Turun</span> .TXT
                </button>
                <button onclick="clearHistory()" class="flex-1 md:flex-none px-4 py-2 bg-red-900/50 border border-red-800 hover:bg-red-900 text-red-200 text-xs font-bold rounded flex items-center justify-center gap-2 transition">
                    <span>üóëÔ∏è</span> Padam <span class="hidden md:inline">Semua</span>
                </button>
            </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar z-10" id="history-scroll-area">
          <div id="history-list" class="space-y-4 pb-10">
              </div>
      </div>

  </div>

  <script>
    // --- HISTORY LOGIC ---
    
    document.addEventListener('DOMContentLoaded', loadHistory);

    function loadHistory() {
        // Reads the same key used in game.js ('kb_game_history')
        const history = JSON.parse(localStorage.getItem('kb_game_history') || '[]');
        const container = document.getElementById('history-list');

        if (history.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-gray-500 opacity-60">
                    <span class="text-6xl mb-4">üï∏Ô∏è</span>
                    <p class="italic text-center">Tiada rekod dijumpai.<br>Mulakan permainan baru!</p>
                </div>`;
            return;
        }

        // Render List (Newest first)
        container.innerHTML = history.reverse().map((game, index) => {
            // Determine Winner Styling
            // Checks for 'Hantu' or 'Pontianak' to apply Evil theme
            const isWinEvil = game.winner.includes('Hantu') || game.winner.includes('Pontianak');
            
            const cardBorder = isWinEvil ? 'border-red-900/50 hover:border-red-600' : 'border-emerald-900/50 hover:border-emerald-600';
            const cardBg = isWinEvil ? 'bg-red-950/20' : 'bg-emerald-950/20';
            const titleColor = isWinEvil ? 'text-red-400' : 'text-emerald-400';
            const badgeBg = isWinEvil ? 'bg-red-900 text-white' : 'bg-emerald-900 text-white';
            const icon = isWinEvil ? 'üßü' : 'üèÜ';

            return `
                <div class="relative p-4 border ${cardBorder} ${cardBg} rounded-xl group transition-all duration-300 hover:bg-black/40">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] md:text-xs text-gray-500 font-mono bg-black/30 px-2 py-1 rounded border border-white/5">
                            üìÖ ${game.date}
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-wider ${badgeBg} px-2 py-0.5 rounded shadow-lg">
                            ${isWinEvil ? 'Kemenangan Hantu' : 'Kemenangan Kampung'}
                        </span>
                    </div>

                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-title text-lg md:text-2xl font-bold ${titleColor} uppercase tracking-wide leading-none">
                                ${game.winner}
                            </h3>
                            <p class="text-xs text-gray-400 mt-1 flex items-center gap-2">
                                <span>üë• ${game.playerCount} Pemain</span>
                                <span class="text-gray-600">‚Ä¢</span>
                                <span>üîÑ ${game.roundCount || game.rounds || '?'} Pusingan</span>
                            </p>
                        </div>
                        <div class="text-4xl md:text-5xl opacity-80 group-hover:scale-110 transition-transform duration-300">
                            ${icon}
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 font-bold">Senarai Watak:</p>
                        <p class="text-xs md:text-sm text-gray-300 leading-relaxed font-mono">
                            ${formatRoster(game.roster)}
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Helper to format roster nicely
    function formatRoster(rosterArray) {
        if (!rosterArray || !Array.isArray(rosterArray)) return "Tiada data watak.";
        // Clean up string format "Name (Role)" -> highlighted HTML
        return rosterArray.map(entry => {
            // Simple split if format is "Name (Role)"
            return `<span class="inline-block bg-black/30 px-1.5 py-0.5 rounded border border-white/5 mr-1 mb-1 whitespace-nowrap">${entry}</span>`;
        }).join('');
    }

    function downloadHistoryTxt() {
        const history = JSON.parse(localStorage.getItem('kb_game_history') || '[]');
        if (history.length === 0) return alert("Tiada data untuk dimuat turun.");

        let txtContent = "=== SEJARAH PERMAINAN KAMPUNG BERHANTU ===\n\n";

        history.forEach((game, i) => {
            txtContent += `PERMAINAN #${i + 1}\n`;
            txtContent += `Tarikh: ${game.date}\n`;
            txtContent += `Pemenang: ${game.winner}\n`;
            txtContent += `Pusingan: ${game.roundCount || game.rounds}\n`;
            txtContent += `Pemain: ${game.playerCount}\n`;
            txtContent += `Senarai: ${game.roster.join(', ')}\n`;
            txtContent += "----------------------------------------\n\n";
        });

        // Create Blob & Download
        const blob = new Blob([txtContent], { type: 'text/plain' });
        const anchor = document.createElement('a');
        anchor.href = window.URL.createObjectURL(blob);
        anchor.download = `Sejarah_Kampung_${new Date().toISOString().slice(0,10)}.txt`;
        anchor.click();
    }

    function clearHistory() {
        if(confirm("Adakah anda pasti mahu memadam semua sejarah permainan?")) {
            localStorage.removeItem('kb_game_history');
            loadHistory();
        }
    }
  </script>
</body>
</html>